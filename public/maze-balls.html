<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>è¿·è·¯ã§è»¢ãŒã™ã‚²ãƒ¼ãƒ ï¼ˆå®‰å®šç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
  </head>

  <body>
    <h1>ã‚¹ãƒãƒ›ã‹ã‚‰ã®ã‚»ãƒ³ã‚µæƒ…å ±ã‚’å—ä¿¡</h1>
    <div>
      <div>ã‚ãªãŸã®ID: <span id="myid"></span></div>
      <button id="connect">ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹</button>
      <div>å—ä¿¡ã—ãŸæƒ…å ±ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã§ç¢ºèªã—ã¦ãã ã•ã„</div>
    </div>

    <script>
      // ===== ã‚½ã‚±ãƒƒãƒˆæ¥ç¶š =====
      let socket = io.connect();
      let btn = document.querySelector("#connect");
      let g = 0; // æ¨ªã®å‚¾ã
      let b = 0; // ç¸¦ã®å‚¾ã

      // IDç”Ÿæˆãƒ»è¡¨ç¤º
      let myid = sessionStorage.getItem("clientId");
      if (!myid) {
        myid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem("clientId", myid);
      }
      document.querySelector("#myid").innerHTML = myid;
      console.log("ã‚ãªãŸã®ID:", myid);

      btn.addEventListener("click", function () {
        socket.emit("join", "game");
        btn.remove();
      });

      // ã‚¹ãƒãƒ›ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿å—ä¿¡
      socket.on("sensor", function (data) {
        g = constrain(parseFloat(data.g), -30, 30); // æœ€å¤§å‚¾ãåˆ¶é™
        b = constrain(parseFloat(data.b), -30, 30);
        console.log(data);
      });

      // ===== p5.jséƒ¨åˆ† =====
      let startX = -300;
      let startY = 300;
      let x = startX;
      let y = startY;
      let r = 20; // ãƒœãƒ¼ãƒ«åŠå¾„
      let speed = 0.4; // ã‚†ã£ãã‚Šã‚ã®é€Ÿåº¦
      let steps = 6; // åˆ†å‰²ç§»å‹•å›æ•°ï¼ˆå¤šã„ã»ã©æ»‘ã‚‰ã‹ï¼‰

      let goalX = 300;
      let goalY = -300;
      let goalSize = 60;

      let walls = [];
      let resetTimer = 0;

      function setup() {
        createCanvas(800, 800);
        rectMode(CENTER);
        textAlign(CENTER, CENTER);
        textSize(40);

        // ===== è¿·è·¯ã®å£ã‚’å®šç¾© =====
        walls.push({ x: 0, y: 0, w: 600, h: 20 });
        walls.push({ x: 0, y: -200, w: 20, h: 400 });
        walls.push({ x: 200, y: 100, w: 20, h: 400 });
        walls.push({ x: -200, y: 200, w: 400, h: 20 });
        walls.push({ x: -300, y: -100, w: 200, h: 20 });
      }

      function draw() {
        background(30);
        translate(width / 2, height / 2);

        // ===== ã‚´ãƒ¼ãƒ« =====
        fill(255, 0, 0);
        rect(goalX, goalY, goalSize, goalSize, 10);

        // ===== å£ =====
        fill(100);
        for (let w of walls) rect(w.x, w.y, w.w, w.h);

        // ===== ãƒœãƒ¼ãƒ«ã®ç§»å‹• =====
        for (let i = 0; i < steps; i++) {
          let newX = x + (g * speed) / steps;
          let newY = y + (b * speed) / steps;

          let hitWall = false;
          for (let w of walls) {
            if (
              newX + r > w.x - w.w / 2 &&
              newX - r < w.x + w.w / 2 &&
              newY + r > w.y - w.h / 2 &&
              newY - r < w.y + w.h / 2
            ) {
              hitWall = true;
              break;
            }
          }

          if (!hitWall) {
            x = newX;
            y = newY;
          } else {
            // å£ã«ã¶ã¤ã‹ã£ãŸã‚‰å°‘ã—åç™º
            x -= (g * speed) / (steps * 2);
            y -= (b * speed) / (steps * 2);
          }
        }

        // ===== ãƒœãƒ¼ãƒ«ãŒè¿·è·¯å¤–ã«å‡ºãŸã‚‰ãƒªã‚»ãƒƒãƒˆ =====
        let limit = 400;
        if (x < -limit || x > limit || y < -limit || y > limit) {
          x = startX;
          y = startY;
          resetTimer = frameCount; // è¡¨ç¤ºã®é–‹å§‹ãƒ•ãƒ¬ãƒ¼ãƒ 
        }

        // ===== ãƒœãƒ¼ãƒ«æç”» =====
        fill(0, 200, 255);
        ellipse(x, y, r * 2);

        // ===== æˆ»ã£ãŸã¨ãã®è¡¨ç¤º =====
        if (frameCount - resetTimer < 60) {
          fill(255);
          text("â†©ï¸ æˆ»ã£ãŸï¼", 0, 0);
        }

        // ===== ã‚´ãƒ¼ãƒ«åˆ¤å®š =====
        if (
          abs(x - goalX) < goalSize / 2 - r &&
          abs(y - goalY) < goalSize / 2 - r
        ) {
          fill(255);
          text("ğŸ‰ CLEAR!!", 0, 0);
          noLoop();
        }
      }
    </script>
  </body>
</html>